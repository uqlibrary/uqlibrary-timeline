<link rel="import" href="../polymer/polymer.html">

<!--
Element providing a simple timeline.

##### Example

    <uqlibrary-timeline></uqlibrary-timeline>

    <script>
      (function () {

        window.addEventListener('polymer-ready', function() {
          var timeline = document.querySelector('uqlibrary-timeline');
          timeline.events = [
            {
              date: new Date().setHours(0, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(24, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            },
            {
              date: new Date().setHours(72, 0, 0, 0),
              title: "Item title",
              subtitle: "Second line",
              text: "Third line"
            }
          ];
        });

      }());
    </script>

@element uqlibrary-timeline
@blurb Element providing a simple timeline.
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-timeline
-->
<polymer-element name="uqlibrary-timeline" attributes="events">

  <template>
    <link rel="stylesheet" href="uqlibrary-timeline.css">

    <div id="timeline">
      <template repeat="{{event, idx in processedEvents}}">

        <template if="{{!event.isDivider}}">
          <div class="timeline-item {{event.class}}">
            <div horizontal layout class="timeline-item-inner">
              <div class="date" vertical layout>
                <div class="day">
                  {{event.day}}
                </div>
                <div class="day-text">
                  {{event.dayText}}
                </div>
              </div>
              <div flex class="item">
                <div class="item-inner">
                  <div class="title">{{event.title}}</div>
                  <div>{{event.subtitle}}</div>
                  <div>{{event.text}}</div>
                </div>
              </div>
            </div>
          </div>
        </template>

        <template if="{{event.isDivider}}">
          <p class="timeline-divider">&nbsp;</p>
        </template>

      </template>
    </div>

  </template>

  <script>
    (function() {
      Polymer('uqlibrary-timeline', {
        /**
         * The `events` attribute is an array of events to display on the timeline.
         *
         * @property events
         * @type array
         */

        /**
         * Time period
         */
        timePeriod: '',

        created: function () {
          this.events = [];
          this.processedEvents = [];
          this.months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          this.dayNames = [
            'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'
          ];
        },

        ready: function () {
        },

        eventsChanged: function () {
          var that = this;

          var events = this.events;
          var processed = [];

          // Sort by date (ascending)
          events.sort(function (a, b) {
            var aDate = new Date(a.date).getTime();
            var bDate = new Date(b.date).getTime();
            if (aDate > bDate) {
              return 1;
            }
            if (aDate < bDate) {
              return -1;
            }
            return 0;
          });

          // Get the events for the next week
          var now = new Date();
          var tomorrow = new Date();
          tomorrow.setHours(24, 0, 0, 0);
          var oneWeek = new Date();
          oneWeek.setHours(144, 0, 0, 0);

          var haveDivider = false;
          for (var i = 0; i < events.length; i++) {
            events[i].date = new Date(events[i].date);
            events[i].time = events[i].date.getTime();
            events[i].day = events[i].date.getDate();
            events[i].dayText = this.dayNames[events[i].date.getDay()];

            if (i > 0 && events[i].date.getDay() === events[(i-1)].date.getDay()) {
              events[(i-1)].class = '';
              events[i].day = '';
              events[i].dayText = '';
            }
            if (i > 0 && events[i].date.getDay() !== events[(i-1)].date.getDay() && !haveDivider) {
              events[(i-1)].class = 'last';
              haveDivider = true;
              processed.push({
                isDivider: true
              });
            }
            if (events[i].time - oneWeek.getTime() <= 0) {
              processed.push(events[i]);
            }
          }

          processed[0].class = 'first';

          var startMonth = that.months[tomorrow.getMonth()];
          that.timePeriod = now.getDate() + ' ' + startMonth;
          that.timePeriod += ' - ' + oneWeek.getDate();
          var endMonth = that.months[oneWeek.getMonth()];

          if (startMonth !== endMonth) {
            that.timePeriod += ' ' + endMonth;
          }

          that.processedEvents = processed;
        }

      });
    })();
  </script>

</polymer-element>
